<!DOCTYPE html>
<html>
  <head>
    <title>ESP32 Web BLE App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta charset="UTF-8" />
    <script src="http://unpkg.com/tone"></script>
  </head>
  <body>
    <div class="topnav">
      <h1>ESP32 Web BLE Application</h1>
    </div>
    <div class="content">
      <div class="card-grid">
        <div class="card">
          <p>
            <button id="connectBleButton" class="connectButton">
              Connect to BLE Device
            </button>
            <button id="disconnectBleButton" class="disconnectButton">
              Disconnect BLE Device
            </button>
          </p>
          <p class="gray-label">
            BLE state:
            <strong
              ><span id="bleState" style="color: #d13a30"
                >Disconnected</span
              ></strong
            >
          </p>
        </div>
      </div>
      <div class="card-grid">
        <div class="card">
          <h2>Buttons Value</h2>
          <p class="reading"><span id="valueContainer">NaN</span></p>
        </div>

        <div class="card">
          <h2>Control</h2>
          <button id="onButton" class="onButton">ON</button>
          <button id="offButton" class="offButton">OFF</button>
          <p class="gray-label">
            Last value sent: <span id="valueSent"></span>
          </p>
        </div>
      </div>
    </div>
  </body>
  <script>
    // DOM Elements
    const connectButton = document.getElementById("connectBleButton");
    const disconnectButton = document.getElementById("disconnectBleButton");
    const onButton = document.getElementById("onButton");
    const offButton = document.getElementById("offButton");
    const retrievedValue = document.getElementById("valueContainer");
    const latestValueSent = document.getElementById("valueSent");
    const bleStateContainer = document.getElementById("bleState");

    //Define BLE Device Specs
    var deviceName = "duda";
    var bleService = "19b10000-e8f2-537e-4f6c-d104768a1214";
    var ledCharacteristic = "19b10002-e8f2-537e-4f6c-d104768a1214";
    var sensorCharacteristic = "19b10001-e8f2-537e-4f6c-d104768a1214";

    //Global Variables to Handle Bluetooth
    var bleServer;
    var bleServiceFound;
    var sensorCharacteristicFound;

    var synth;
    var isEnabled = false;
    var synth = new Tone.Sampler({
      urls: {
        A2: "../samples/A2.mp3",
        "D#2": "../samples/D#2.mp3",
        A3: "../samples/A3.mp3",
        C4: "../samples/C4.mp3",
        E4: "../samples/E4.mp3",
        A4: "../samples/A4.mp3",
      },
      baseUrl: "/",
    }).toDestination();

    var droneSynth = new Tone.Sampler({
      urls: {
        A2: "../samples/A2.mp3",
        "D#2": "../samples/D#2.mp3",
        A3: "../samples/A3.mp3",
        C4: "../samples/C4.mp3",
        E4: "../samples/E4.mp3",
        A4: "../samples/A4.mp3",
      },
      baseUrl: "/",
    }).toDestination();

    // Connect Button (search for BLE Devices only if BLE is available)
    connectButton.addEventListener("click", (event) => {
      if (isWebBluetoothEnabled()) {
        connectToDevice();
      }
    });

    // Disconnect Button
    disconnectButton.addEventListener("click", disconnectDevice);

    // Write to the ESP32 LED Characteristic
    onButton.addEventListener("click", () => writeOnCharacteristic(1));
    offButton.addEventListener("click", () => writeOnCharacteristic(0));

    // Check if BLE is available in your Browser
    function isWebBluetoothEnabled() {
      if (!navigator.bluetooth) {
        console.log("Web Bluetooth API is not available in this browser!");
        bleStateContainer.innerHTML =
          "Web Bluetooth API is not available in this browser/device!";
        return false;
      }
      console.log("Web Bluetooth API supported in this browser.");
      return true;
    }

    // Connect to BLE Device and Enable Notifications
    function connectToDevice() {
      console.log("Initializing Bluetooth...");
      navigator.bluetooth
        .requestDevice({
          // acceptAllDevices: true,
          filters: [{ namePrefix: deviceName }],
          optionalServices: [bleService],
        })
        .then((device) => {
          console.log("Device Selected:", device.name);
          bleStateContainer.innerHTML = "Connected to device " + device.name;
          bleStateContainer.style.color = "#24af37";
          device.addEventListener("gattservicedisconnected", onDisconnected);
          return device.gatt.connect();
        })
        .then((gattServer) => {
          bleServer = gattServer;
          console.log("Connected to GATT Server");
          return bleServer.getPrimaryService(bleService);
        })
        .then((service) => {
          bleServiceFound = service;
          console.log("Service discovered:", service.uuid);
          return service.getCharacteristic(sensorCharacteristic);
        })
        .then((characteristic) => {
          console.log("Characteristic discovered:", characteristic.uuid);
          sensorCharacteristicFound = characteristic;
          characteristic.addEventListener(
            "characteristicvaluechanged",
            handleCharacteristicChange
          );
          characteristic.startNotifications();
          console.log("Notifications Started.");
          return characteristic.readValue();
        })
        .then((value) => {
          console.log("Read value: ", value);
          const decodedValue = new TextDecoder().decode(value);
          console.log("Decoded value: ", decodedValue);
          retrievedValue.innerHTML = decodedValue;
        })
        .catch((error) => {
          console.log("Error: ", error);
        });
    }

    function onDisconnected(event) {
      console.log("Device Disconnected:", event.target.device.name);
      bleStateContainer.innerHTML = "Device disconnected";
      bleStateContainer.style.color = "#d13a30";

      connectToDevice();
    }

    function handleCharacteristicChange(event) {
      const newValueReceived = new TextDecoder().decode(event.target.value);
      console.log("Characteristic value changed: ", newValueReceived);
      retrievedValue.innerHTML = newValueReceived;

      const now = Tone.now();
      let IS_DRONE_PLAYING = false;
      const IS_OPEN = 0;
      const OCTAVE = 3;
      const DRONE_NOTE = `A${OCTAVE - 1}`;
      const NOTES = [
        `F#${OCTAVE + 1}`,
        `E${OCTAVE + 1}`,
        `D${OCTAVE + 1}`,
        `C#${OCTAVE + 1}`,
        `B${OCTAVE}`,
        `A${OCTAVE}`,
        `G${OCTAVE}`,
        `F#${OCTAVE}`,
        `E${OCTAVE}`,
      ];

      if (newValueReceived == "000000000") {
        synth.releaseAll();
        droneSynth.releaseAll();
        IS_DRONE_PLAYING = false;
        return;
      }

      synth.releaseAll();

      if (newValueReceived == "101111111") {
        isEnabled = !isEnabled;
      }

      if (!isEnabled) {
        return;
      }

      if (!IS_DRONE_PLAYING) {
        console.log("DRONE_NOTE", DRONE_NOTE);
        droneSynth.triggerRelease(DRONE_NOTE, now);
        droneSynth.triggerAttack(DRONE_NOTE, now);
        IS_DRONE_PLAYING = true;
      }

     

      for (let i = 0; i < NOTES.length - 1; i++) {
        if (newValueReceived[i] == IS_OPEN) {
          synth.triggerRelease(NOTES.at(-1), now);
          synth.triggerAttack(NOTES[i], now);
          console.log(NOTES[i]);
          break;
        }
      }

      if (newValueReceived === "000000000") {
        return;
      }

      if (newValueReceived === "101111111") {
        synth.triggerAttack(NOTES.at(-1), now);
        return;
      }

      if (!isEnabled) {
        return;
      }

      for (let i = 1; i < NOTES.length; i++) {
        if (newValueReceived[i] == 0) {
          synth.triggerAttack(NOTES[i - 1], now);
          break;
        }
      }
    }

    function writeOnCharacteristic(value) {
      if (bleServer && bleServer.connected) {
        bleServiceFound
          .getCharacteristic(ledCharacteristic)
          .then((characteristic) => {
            console.log("Found the LED characteristic: ", characteristic.uuid);
            const data = new Uint8Array([value]);
            return characteristic.writeValue(data);
          })
          .then(() => {
            latestValueSent.innerHTML = value;
            console.log("Value written to LEDcharacteristic:", value);
          })
          .catch((error) => {
            console.error("Error writing to the LED characteristic: ", error);
          });
      } else {
        console.error(
          "Bluetooth is not connected. Cannot write to characteristic."
        );
        window.alert(
          "Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!"
        );
      }
    }

    function disconnectDevice() {
      synth?.triggerRelease();
      isEnabled = false;

      console.log("Disconnect Device.");
      if (bleServer && bleServer.connected) {
        if (sensorCharacteristicFound) {
          sensorCharacteristicFound
            .stopNotifications()
            .then(() => {
              console.log("Notifications Stopped");
              return bleServer.disconnect();
            })
            .then(() => {
              console.log("Device Disconnected");
              bleStateContainer.innerHTML = "Device Disconnected";
              bleStateContainer.style.color = "#d13a30";
            })
            .catch((error) => {
              console.log("An error occurred:", error);
            });
        } else {
          console.log("No characteristic found to disconnect.");
        }
      } else {
        // Throw an error if Bluetooth is not connected
        console.error("Bluetooth is not connected.");
        window.alert("Bluetooth is not connected.");
      }
    }
  </script>
  <script></script>
</html>
